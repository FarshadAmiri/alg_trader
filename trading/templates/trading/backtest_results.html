{% extends 'trading/base.html' %}

{% block title %}Backtest Results #{{ backtest.id }} - Algo Trader{% endblock %}

{% block content %}
<div class="card">
    <h2>Backtest #{{ backtest.id }} - {{ backtest.strategy.name }}</h2>
    
    <p><strong>Status:</strong> <span class="status-{{ backtest.status }}">{{ backtest.get_status_display }}</span></p>
    <p><strong>Period:</strong> {{ backtest.start_time|date:"Y-m-d H:i" }} to {{ backtest.end_time|date:"Y-m-d H:i" }}</p>
    <p><strong>Symbols:</strong> {{ backtest.symbol_universe|join:", " }}</p>
    <p><strong>Timeframe:</strong> {{ backtest.base_timeframe }}</p>
    <p><strong>Max Hold:</strong> {{ backtest.window_hours }}h 
        {% if backtest.shift_hours < 0.5 %}
        (checks every bar)
        {% else %}
        (checks every {{ backtest.shift_hours }}h)
        {% endif %}
    </p>
    <p><strong>Fees:</strong> {{ backtest.fee_bps }} bps ({{ backtest.fee_bps|floatformat:2|add:"0"|floatformat:2 }}% per side)</p>
    {% if backtest.slippage_bps > 0 %}
    <p><strong>Slippage:</strong> {{ backtest.slippage_bps }} bps</p>
    {% endif %}
    
    {% if backtest.status == 'failed' %}
    <div style="background: #f8d7da; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
        <strong>Error:</strong> {{ backtest.error_message }}
    </div>
    {% endif %}
    
    {% if backtest.status == 'pending' %}
    <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
        <strong>Run this backtest:</strong>
        <pre style="margin-top: 0.5rem;">python manage.py run_backtest --strategy "{{ backtest.strategy.name }}" --symbols "{{ backtest.symbol_universe|join:"," }}" --start-date "{{ backtest.start_time|date:"Y-m-d H:i" }}" --end-date "{{ backtest.end_time|date:"Y-m-d H:i" }}"</pre>
    </div>
    {% endif %}
</div>

{% if chart_data_json %}
<div class="card">
    <h2>Price Chart & Trades</h2>
    
    <div style="margin-bottom: 1rem;">
        <label for="symbolSelect" style="margin-right: 0.5rem;"><strong>Select Symbol:</strong></label>
        <select id="symbolSelect" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
        </select>
    </div>
    
    <div id="priceChart" style="width: 100%; height: 600px;"></div>
</div>
{% endif %}

{% if performance %}
<div class="card">
    <h2>Performance Summary</h2>
    
    <div style="margin: 1.5rem 0;">
        <div class="metric">
            <div class="metric-value">{{ performance.total_trades }}</div>
            <div class="metric-label">Total Trades</div>
        </div>
        
        <div class="metric">
            <div class="metric-value">{{ performance.win_rate|floatformat:1 }}%</div>
            <div class="metric-label">Win Rate</div>
        </div>
        
        <div class="metric">
            <div class="metric-value {% if performance.avg_return_pct > 0 %}positive{% else %}negative{% endif %}">
                {{ performance.avg_return_pct|floatformat:2 }}%
            </div>
            <div class="metric-label">Avg Return</div>
        </div>
        
        <div class="metric">
            <div class="metric-value {% if performance.total_return_pct > 0 %}positive{% else %}negative{% endif %}">
                {{ performance.total_return_pct|floatformat:2 }}%
            </div>
            <div class="metric-label">Total Return</div>
        </div>
        
        <div class="metric">
            <div class="metric-value negative">{{ performance.max_drawdown|floatformat:2 }}%</div>
            <div class="metric-label">Max Drawdown</div>
        </div>
        
        {% if performance.profit_factor %}
        <div class="metric">
            <div class="metric-value">{{ performance.profit_factor|floatformat:2 }}</div>
            <div class="metric-label">Profit Factor</div>
        </div>
        {% endif %}
    </div>
    
    <table style="margin-top: 1rem;">
        <tr>
            <td><strong>Winning Trades:</strong></td>
            <td>{{ performance.winning_trades }}</td>
        </tr>
        <tr>
            <td><strong>Losing Trades:</strong></td>
            <td>{{ performance.losing_trades }}</td>
        </tr>
        <tr>
            <td><strong>Median Return:</strong></td>
            <td>{{ performance.median_return_pct|floatformat:2 }}%</td>
        </tr>
    </table>
</div>
{% endif %}

{% if symbol_stats %}
<div class="card">
    <h2>Per-Symbol Statistics</h2>
    
    <table>
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Trades</th>
                <th>Win Rate</th>
                <th>Avg Return</th>
            </tr>
        </thead>
        <tbody>
            {% for symbol, stats in symbol_stats.items %}
            <tr>
                <td><strong>{{ symbol }}</strong></td>
                <td>{{ stats.total_trades }}</td>
                <td>{{ stats.win_rate|floatformat:1 }}%</td>
                <td class="{% if stats.avg_return > 0 %}positive{% else %}negative{% endif %}">
                    {{ stats.avg_return|floatformat:2 }}%
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if trades %}
<div class="card">
    <h2>Trades (showing {{ trades|length }} of {{ total_trades }})</h2>
    
    <table>
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Entry Time</th>
                <th>Exit Time</th>
                <th>Direction</th>
                <th>Return %</th>
                <th>Max DD %</th>
            </tr>
        </thead>
        <tbody>
            {% for trade in trades %}
            <tr>
                <td><strong>{{ trade.symbol }}</strong></td>
                <td>{{ trade.entry_time|date:"Y-m-d H:i" }}</td>
                <td>{{ trade.exit_time|date:"Y-m-d H:i" }}</td>
                <td>{{ trade.direction }}</td>
                <td class="{% if trade.return_pct > 0 %}positive{% else %}negative{% endif %}">
                    {{ trade.return_pct|floatformat:2 }}%
                </td>
                <td class="negative">{{ trade.max_drawdown|floatformat:2 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if total_trades > trades|length %}
    <p style="margin-top: 1rem; color: #7f8c8d;">
        <em>Showing first {{ trades|length }} trades. View all {{ total_trades }} trades in Django admin.</em>
    </p>
    {% endif %}
</div>
{% else %}
<div class="card">
    <p>No trade results yet. Run the backtest using the management command.</p>
</div>
{% endif %}

<p style="margin-top: 1rem;">
    <a href="{% url 'trading:index' %}" class="btn">Back to Home</a>
    <a href="{% url 'trading:backtest_run' %}" class="btn btn-success">Run Another Backtest</a>
</p>

{% if chart_data_json %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
<script>
const chartData = {{ chart_data_json|safe }};
const symbols = Object.keys(chartData);
const symbolSelect = document.getElementById('symbolSelect');

// Populate symbol dropdown
symbols.forEach(symbol => {
    const option = document.createElement('option');
    option.value = symbol;
    option.textContent = symbol;
    symbolSelect.appendChild(option);
});

function renderChart(symbol) {
    const data = chartData[symbol];
    if (!data || !data.candles || data.candles.length === 0) {
        document.getElementById('priceChart').innerHTML = '<p style="text-align: center; padding: 2rem; color: #999;">No price data available for ' + symbol + '</p>';
        return;
    }
    
    const candles = data.candles;
    const trades = data.trades || [];
    
    // Prepare candlestick data
    const timestamps = candles.map(c => c.timestamp);
    const opens = candles.map(c => c.open);
    const highs = candles.map(c => c.high);
    const lows = candles.map(c => c.low);
    const closes = candles.map(c => c.close);
    
    // Create candlestick trace
    const candlestickTrace = {
        type: 'candlestick',
        x: timestamps,
        open: opens,
        high: highs,
        low: lows,
        close: closes,
        name: symbol,
        increasing: {line: {color: '#27ae60'}},
        decreasing: {line: {color: '#e74c3c'}}
    };
    
    // Create shapes for vertical lines and holding period highlights
    const shapes = [];
    const annotations = [];
    
    trades.forEach(trade => {
        const isLong = trade.direction === 'long' || trade.direction === 'LONG';
        const profitColor = trade.return_pct > 0 ? '#27ae60' : '#e74c3c';
        
        // Vertical line at entry (blue)
        shapes.push({
            type: 'line',
            x0: trade.entry_time,
            x1: trade.entry_time,
            y0: 0,
            y1: 1,
            yref: 'paper',
            line: {
                color: '#3498db',
                width: 2,
                dash: 'solid'
            }
        });
        
        // Vertical line at exit (color based on profit/loss)
        shapes.push({
            type: 'line',
            x0: trade.exit_time,
            x1: trade.exit_time,
            y0: 0,
            y1: 1,
            yref: 'paper',
            line: {
                color: profitColor,
                width: 2,
                dash: 'solid'
            }
        });
        
        // Shaded rectangle for holding period
        shapes.push({
            type: 'rect',
            x0: trade.entry_time,
            x1: trade.exit_time,
            y0: 0,
            y1: 1,
            yref: 'paper',
            fillcolor: profitColor,
            opacity: 0.1,
            line: {width: 0}
        });
        
        // Annotation for entry
        annotations.push({
            x: trade.entry_time,
            y: 0.98,
            yref: 'paper',
            text: isLong ? '▲ BUY' : '▼ SHORT',
            showarrow: false,
            font: {
                size: 10,
                color: '#3498db'
            },
            bgcolor: 'rgba(255,255,255,0.8)',
            borderpad: 2
        });
        
        // Annotation for exit with profit/loss
        annotations.push({
            x: trade.exit_time,
            y: 0.02,
            yref: 'paper',
            text: `${isLong ? 'SELL' : 'COVER'}: ${trade.return_pct.toFixed(2)}%`,
            showarrow: false,
            font: {
                size: 10,
                color: profitColor
            },
            bgcolor: 'rgba(255,255,255,0.8)',
            borderpad: 2
        });
    });
    
    const layout = {
        title: {
            text: symbol + ' Price Chart with Trades',
            font: {size: 18}
        },
        xaxis: {
            title: 'Time',
            rangeslider: {visible: true},
            type: 'date'
        },
        yaxis: {
            title: 'Price (USDT)',
            fixedrange: false
        },
        shapes: shapes,
        annotations: annotations,
        hovermode: 'x unified',
        showlegend: true,
        legend: {
            x: 0,
            y: 1,
            bgcolor: 'rgba(255,255,255,0.8)'
        },
        margin: {l: 60, r: 30, t: 60, b: 100}
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false
    };
    
    Plotly.newPlot('priceChart', [candlestickTrace], layout, config);
}

// Render initial chart
if (symbols.length > 0) {
    renderChart(symbols[0]);
}

// Handle symbol change
symbolSelect.addEventListener('change', function() {
    renderChart(this.value);
});
</script>
{% endif %}
{% endblock %}
